name: Integration Tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch: # Allow manual triggering

env:
  # Test video is stored in the repository at assets/test_video.mp4
  TEST_VIDEO_PATH: "assets/test_video.mp4"
  TEST_VIDEO_NAME: "test_video.mp4"

jobs:
  # Verify test video from repository
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify test video exists
        run: |
          echo "Verifying test video from repository..."
          ls -la ${{ env.TEST_VIDEO_PATH }}

      - name: Verify video with ffprobe
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 ${{ env.TEST_VIDEO_PATH }}

      - name: Upload test video artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-video
          path: ${{ env.TEST_VIDEO_PATH }}
          retention-days: 1

  # Integration tests on Ubuntu with different shells
  integration-linux:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shell: [bash, zsh, fish]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install shell (${{ matrix.shell }})
        run: |
          if [ "${{ matrix.shell }}" = "zsh" ]; then
            sudo apt-get install -y zsh
          elif [ "${{ matrix.shell }}" = "fish" ]; then
            sudo apt-add-repository -y ppa:fish-shell/release-3
            sudo apt-get update
            sudo apt-get install -y fish
          fi

      - name: Build capycut
        run: go build -o capycut .

      - name: Download test video
        uses: actions/download-artifact@v4
        with:
          name: test-video

      - name: Get video duration
        id: video-info
        run: |
          DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 ${{ env.TEST_VIDEO_NAME }})
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "Video duration: $DURATION seconds"

      - name: Test setup wizard config generation (bash/zsh)
        if: matrix.shell != 'fish'
        run: |
          # Test that we can generate valid shell config
          ./capycut --help | grep -q "setup"
          echo "Setup command is available"

      - name: Run integration test - clip first 5 seconds (${{ matrix.shell }})
        env:
          # Use a mock LLM response by setting up environment
          LLM_PROVIDER: "local"
          LLM_ENDPOINT: "http://localhost:11434"
          LLM_MODEL: "test-model"
        run: |
          # For integration tests without a real LLM, we test the CLI parsing and ffmpeg integration
          # by manually providing timestamps (simulating what the LLM would return)
          
          # Test 1: Verify capycut builds and runs
          ./capycut --version
          
          # Test 2: Verify help output
          ./capycut --help | grep -q "file"
          ./capycut --help | grep -q "prompt"
          ./capycut --help | grep -q "provider"
          
          echo "CLI tests passed for ${{ matrix.shell }}"

      - name: Run FFmpeg clip test directly
        run: |
          # Test that FFmpeg can actually clip the video
          ffmpeg -i ${{ env.TEST_VIDEO_NAME }} -ss 00:00:00 -to 00:00:05 -c copy test_clip_output.mp4 -y
          
          # Verify output exists and has content
          test -f test_clip_output.mp4
          OUTPUT_SIZE=$(stat -f%z test_clip_output.mp4 2>/dev/null || stat -c%s test_clip_output.mp4)
          echo "Output clip size: $OUTPUT_SIZE bytes"
          test $OUTPUT_SIZE -gt 0
          
          # Verify output duration is approximately 5 seconds
          OUTPUT_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 test_clip_output.mp4)
          echo "Output clip duration: $OUTPUT_DURATION seconds"

      - name: Test shell config generation
        run: |
          # Create a test to verify shell-specific config generation
          go test -v -run "TestGenerateEnvExports" ./...

  # Integration tests on macOS
  integration-macos:
    needs: setup
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        shell: [bash, zsh]  # macOS has bash and zsh by default
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install FFmpeg
        run: brew install ffmpeg

      - name: Build capycut
        run: go build -o capycut .

      - name: Download test video
        uses: actions/download-artifact@v4
        with:
          name: test-video

      - name: Run integration tests
        run: |
          ./capycut --version
          ./capycut --help
          
          # Test FFmpeg integration
          ffmpeg -i ${{ env.TEST_VIDEO_NAME }} -ss 00:00:00 -to 00:00:03 -c copy macos_clip.mp4 -y
          test -f macos_clip.mp4
          echo "macOS integration test passed for ${{ matrix.shell }}"

  # Integration tests on Windows with PowerShell
  integration-windows:
    needs: setup
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        shell: [pwsh, powershell]  # PowerShell 7 (pwsh) and Windows PowerShell 5.x
    defaults:
      run:
        shell: ${{ matrix.shell }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install FFmpeg
        run: choco install ffmpeg -y

      - name: Build capycut
        run: go build -o capycut.exe .

      - name: Download test video
        uses: actions/download-artifact@v4
        with:
          name: test-video

      - name: Verify FFmpeg installation
        run: |
          ffmpeg -version
          ffprobe -version

      - name: Run integration tests
        run: |
          .\capycut.exe --version
          .\capycut.exe --help
          
          # Test FFmpeg integration on Windows
          ffmpeg -i ${{ env.TEST_VIDEO_NAME }} -ss 00:00:00 -to 00:00:03 -c copy windows_clip.mp4 -y
          
          if (Test-Path windows_clip.mp4) {
            Write-Host "Windows integration test passed for ${{ matrix.shell }}"
          } else {
            Write-Error "Clip file was not created"
            exit 1
          }

      - name: Test PowerShell config generation
        run: |
          # Verify PowerShell-specific tests pass
          go test -v -run "PowerShell" ./...

      - name: Test shell detection on Windows
        run: |
          # Test that the shell detection works on Windows
          $shell = $env:SHELL
          $psModulePath = $env:PSModulePath
          Write-Host "SHELL: $shell"
          Write-Host "PSModulePath: $psModulePath"
          Write-Host "Running in: ${{ matrix.shell }}"

  # End-to-end test with Azure OpenAI
  e2e-with-azure:
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    # Only run on main branch pushes or manual triggers (workflow_dispatch)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install FFmpeg (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install FFmpeg (macOS)
        if: runner.os == 'macOS'
        run: brew install ffmpeg

      - name: Install FFmpeg (Windows)
        if: runner.os == 'Windows'
        run: choco install ffmpeg -y

      - name: Build capycut (Unix)
        if: runner.os != 'Windows'
        run: go build -o capycut .

      - name: Build capycut (Windows)
        if: runner.os == 'Windows'
        run: go build -o capycut.exe .

      - name: Download test video
        uses: actions/download-artifact@v4
        with:
          name: test-video

      - name: Run end-to-end test with Azure OpenAI (Unix)
        if: runner.os != 'Windows'
        env:
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_MODEL: ${{ secrets.AZURE_OPENAI_MODEL }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
        run: |
          # Verify Azure credentials are set (all required vars)
          if [ -z "$AZURE_OPENAI_ENDPOINT" ] || [ -z "$AZURE_OPENAI_API_KEY" ] || [ -z "$AZURE_OPENAI_MODEL" ]; then
            echo "Azure OpenAI credentials not configured. Skipping E2E test."
            echo "To enable this test, add the following secrets to your repository:"
            echo "  - AZURE_OPENAI_ENDPOINT"
            echo "  - AZURE_OPENAI_API_KEY"
            echo "  - AZURE_OPENAI_MODEL"
            echo "  - AZURE_OPENAI_API_VERSION (optional, defaults to 2025-04-01-preview)"
            exit 0
          fi
          
          echo "Running E2E test with Azure OpenAI on ${{ runner.os }}..."
          
          # Run capycut with Azure OpenAI (non-interactive mode with --file and --prompt)
          ./capycut --file ${{ env.TEST_VIDEO_NAME }} --prompt "first 5 seconds" --output e2e_clip.mp4 || {
            echo "E2E test failed"
            exit 1
          }
          
          # Verify output was created
          if [ -f e2e_clip.mp4 ]; then
            echo "E2E test passed - clip created successfully"
            DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 e2e_clip.mp4)
            echo "Output clip duration: $DURATION seconds"
            
            # Verify duration is approximately 5 seconds (with 1 second tolerance)
            if [ $(echo "$DURATION > 4" | bc -l) -eq 1 ] && [ $(echo "$DURATION < 6" | bc -l) -eq 1 ]; then
              echo "Duration verification passed!"
            else
              echo "Warning: Duration $DURATION is outside expected range (4-6 seconds)"
            fi
          else
            echo "E2E test failed - clip was not created"
            exit 1
          fi

      - name: Run end-to-end test with Azure OpenAI (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_MODEL: ${{ secrets.AZURE_OPENAI_MODEL }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
        run: |
          # Verify Azure credentials are set (all required vars)
          if (-not $env:AZURE_OPENAI_ENDPOINT -or -not $env:AZURE_OPENAI_API_KEY -or -not $env:AZURE_OPENAI_MODEL) {
            Write-Host "Azure OpenAI credentials not configured. Skipping E2E test."
            Write-Host "To enable this test, add the following secrets to your repository:"
            Write-Host "  - AZURE_OPENAI_ENDPOINT"
            Write-Host "  - AZURE_OPENAI_API_KEY"
            Write-Host "  - AZURE_OPENAI_MODEL"
            Write-Host "  - AZURE_OPENAI_API_VERSION (optional, defaults to 2025-04-01-preview)"
            exit 0
          }
          
          Write-Host "Running E2E test with Azure OpenAI on ${{ runner.os }}..."
          
          # Run capycut with Azure OpenAI (non-interactive mode with --file and --prompt)
          .\capycut.exe --file ${{ env.TEST_VIDEO_NAME }} --prompt "first 5 seconds" --output e2e_clip.mp4
          if ($LASTEXITCODE -ne 0) {
            Write-Error "E2E test failed"
            exit 1
          }
          
          # Verify output was created
          if (Test-Path e2e_clip.mp4) {
            Write-Host "E2E test passed - clip created successfully"
            $duration = ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 e2e_clip.mp4
            Write-Host "Output clip duration: $duration seconds"
            
            # Verify duration is approximately 5 seconds (with 1 second tolerance)
            $durationNum = [double]$duration
            if ($durationNum -gt 4 -and $durationNum -lt 6) {
              Write-Host "Duration verification passed!"
            } else {
              Write-Host "Warning: Duration $duration is outside expected range (4-6 seconds)"
            }
          } else {
            Write-Error "E2E test failed - clip was not created"
            exit 1
          }

      - name: Run integration tests with Azure (Unix)
        if: runner.os != 'Windows'
        env:
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_MODEL: ${{ secrets.AZURE_OPENAI_MODEL }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          TEST_VIDEO_PATH: ${{ env.TEST_VIDEO_NAME }}
        run: |
          if [ -z "$AZURE_OPENAI_ENDPOINT" ] || [ -z "$AZURE_OPENAI_API_KEY" ]; then
            echo "Skipping Azure integration tests - credentials not configured"
            exit 0
          fi
          
          go test -v -tags=integration -run "TestIntegration_EnvironmentDetection" ./...

      - name: Run integration tests with Azure (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_MODEL: ${{ secrets.AZURE_OPENAI_MODEL }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          TEST_VIDEO_PATH: ${{ env.TEST_VIDEO_NAME }}
        run: |
          if (-not $env:AZURE_OPENAI_ENDPOINT -or -not $env:AZURE_OPENAI_API_KEY) {
            Write-Host "Skipping Azure integration tests - credentials not configured"
            exit 0
          }
          
          go test -v -tags=integration -run "TestIntegration_EnvironmentDetection" ./...

      - name: Run unit tests
        run: go test -v ./...

  # Summary job
  integration-summary:
    needs: [integration-linux, integration-macos, integration-windows, e2e-with-azure]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check integration test results
        run: |
          echo "Integration test summary:"
          echo "========================="
          echo "Linux tests: ${{ needs.integration-linux.result }}"
          echo "macOS tests: ${{ needs.integration-macos.result }}"
          echo "Windows tests: ${{ needs.integration-windows.result }}"
          echo "E2E with Azure: ${{ needs.e2e-with-azure.result }}"
          
          if [ "${{ needs.integration-linux.result }}" = "failure" ] || \
             [ "${{ needs.integration-macos.result }}" = "failure" ] || \
             [ "${{ needs.integration-windows.result }}" = "failure" ]; then
            echo "Some integration tests failed!"
            exit 1
          fi
          
          # E2E with Azure is allowed to be skipped (for forks without secrets)
          if [ "${{ needs.e2e-with-azure.result }}" = "failure" ]; then
            echo "E2E test with Azure failed!"
            exit 1
          fi
          
          echo "All integration tests passed!"
