name: Post-Release Install Tests

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to test (e.g., v1.0.0). Leave empty to test latest.'
        required: false
        default: ''

jobs:
  # Test install.sh on Linux
  test-install-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64]  # GitHub runners are x64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for release assets to be available
        run: |
          echo "Waiting 30 seconds for release assets to propagate..."
          sleep 30

      - name: Test install.sh
        run: |
          echo "Testing install.sh on Linux..."
          chmod +x install.sh
          ./install.sh
          
      - name: Verify installation
        run: |
          # Check if capycut is installed
          if [ -f "$HOME/.local/bin/capycut" ]; then
            CAPYCUT_PATH="$HOME/.local/bin/capycut"
          elif [ -f "/usr/local/bin/capycut" ]; then
            CAPYCUT_PATH="/usr/local/bin/capycut"
          else
            echo "capycut not found in expected locations"
            exit 1
          fi
          
          echo "Found capycut at: $CAPYCUT_PATH"
          
          # Test version command
          "$CAPYCUT_PATH" --version
          
          # Test help command - check for common help patterns
          HELP_OUTPUT=$("$CAPYCUT_PATH" --help)
          if echo "$HELP_OUTPUT" | grep -qiE "(capycut|USAGE:|OPTIONS:)"; then
            echo "Help command works correctly"
          else
            echo "Help output doesn't contain expected content"
            echo "$HELP_OUTPUT"
            exit 1
          fi
          
          echo "Linux installation test passed!"

      - name: Test update functionality
        run: |
          if [ -f "$HOME/.local/bin/capycut" ]; then
            CAPYCUT_PATH="$HOME/.local/bin/capycut"
          else
            CAPYCUT_PATH="/usr/local/bin/capycut"
          fi
          
          # Test that update command exists and runs (should say already up to date)
          "$CAPYCUT_PATH" --update || true
          echo "Update functionality test passed!"

  # Test install.sh on macOS
  test-install-macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-latest
            arch: arm64
          - runner: macos-13
            arch: amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for release assets to be available
        run: |
          echo "Waiting 30 seconds for release assets to propagate..."
          sleep 30

      - name: Test install.sh
        run: |
          echo "Testing install.sh on macOS (${{ matrix.arch }})..."
          chmod +x install.sh
          ./install.sh

      - name: Verify installation
        run: |
          # Check if capycut is installed
          if [ -f "$HOME/.local/bin/capycut" ]; then
            CAPYCUT_PATH="$HOME/.local/bin/capycut"
          elif [ -f "/usr/local/bin/capycut" ]; then
            CAPYCUT_PATH="/usr/local/bin/capycut"
          else
            echo "capycut not found in expected locations"
            exit 1
          fi
          
          echo "Found capycut at: $CAPYCUT_PATH"
          
          # Test version command
          "$CAPYCUT_PATH" --version
          
          # Test help command - check for common help patterns
          HELP_OUTPUT=$("$CAPYCUT_PATH" --help)
          if echo "$HELP_OUTPUT" | grep -qiE "(capycut|USAGE:|OPTIONS:)"; then
            echo "Help command works correctly"
          else
            echo "Help output doesn't contain expected content"
            echo "$HELP_OUTPUT"
            exit 1
          fi
          
          echo "macOS installation test passed!"

      - name: Test update functionality
        run: |
          if [ -f "$HOME/.local/bin/capycut" ]; then
            CAPYCUT_PATH="$HOME/.local/bin/capycut"
          else
            CAPYCUT_PATH="/usr/local/bin/capycut"
          fi
          
          # Test that update command exists and runs
          "$CAPYCUT_PATH" --update || true
          echo "Update functionality test passed!"

  # Test install.ps1 on Windows
  test-install-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        shell: [pwsh, powershell]
    defaults:
      run:
        shell: ${{ matrix.shell }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for release assets to be available
        run: |
          Write-Host "Waiting 30 seconds for release assets to propagate..."
          Start-Sleep -Seconds 30

      - name: Test install.ps1
        run: |
          Write-Host "Testing install.ps1 on Windows with ${{ matrix.shell }}..."
          .\install.ps1 -Force

      - name: Verify installation
        run: |
          # Check common install locations
          $localAppData = [Environment]::GetFolderPath("LocalApplicationData")
          $installPath = Join-Path $localAppData "Programs\capycut\capycut.exe"
          
          if (Test-Path $installPath) {
            $capycutPath = $installPath
          } else {
            # Search in PATH
            $capycutPath = (Get-Command capycut -ErrorAction SilentlyContinue).Source
          }
          
          if (-not $capycutPath) {
            Write-Error "capycut not found"
            exit 1
          }
          
          Write-Host "Found capycut at: $capycutPath"
          
          # Test version command
          & $capycutPath --version
          
          # Test help command - check for common help patterns
          $helpOutput = & $capycutPath --help | Out-String
          if ($helpOutput -match "(?i)capycut" -or $helpOutput -match "USAGE:" -or $helpOutput -match "OPTIONS:") {
            Write-Host "Help command works correctly"
          } else {
            Write-Error "Help output doesn't contain expected content. Output: $helpOutput"
            exit 1
          }
          
          Write-Host "Windows installation test passed!"

      - name: Test update functionality
        run: |
          $localAppData = [Environment]::GetFolderPath("LocalApplicationData")
          $capycutPath = Join-Path $localAppData "Programs\capycut\capycut.exe"
          
          if (-not (Test-Path $capycutPath)) {
            $capycutPath = (Get-Command capycut -ErrorAction SilentlyContinue).Source
          }
          
          # Test that update command exists and runs
          try {
            & $capycutPath --update
          } catch {
            # Update might fail if already latest, that's OK
          }
          Write-Host "Update functionality test passed!"

  # Test curl/wget installation methods on Linux
  test-curl-install-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for release assets to be available
        run: |
          echo "Waiting 30 seconds for release assets to propagate..."
          sleep 30

      - name: Test curl installation method
        run: |
          echo "Testing: curl -fsSL ... | sh"
          curl -fsSL https://raw.githubusercontent.com/harmonyvt/capycut/master/install.sh | sh
          
      - name: Verify curl installation
        run: |
          if [ -f "$HOME/.local/bin/capycut" ]; then
            "$HOME/.local/bin/capycut" --version
          elif [ -f "/usr/local/bin/capycut" ]; then
            "/usr/local/bin/capycut" --version
          else
            echo "capycut not found after curl install"
            exit 1
          fi
          echo "Curl installation method test passed!"

  # Test wget installation method on Linux
  test-wget-install-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for release assets to be available
        run: |
          echo "Waiting 30 seconds for release assets to propagate..."
          sleep 30

      - name: Test wget installation method
        run: |
          echo "Testing: wget -qO- ... | sh"
          wget -qO- https://raw.githubusercontent.com/harmonyvt/capycut/master/install.sh | sh
          
      - name: Verify wget installation
        run: |
          if [ -f "$HOME/.local/bin/capycut" ]; then
            "$HOME/.local/bin/capycut" --version
          elif [ -f "/usr/local/bin/capycut" ]; then
            "/usr/local/bin/capycut" --version
          else
            echo "capycut not found after wget install"
            exit 1
          fi
          echo "Wget installation method test passed!"

  # Test PowerShell remote installation on Windows
  test-irm-install-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Wait for release assets to be available
        run: |
          Write-Host "Waiting 30 seconds for release assets to propagate..."
          Start-Sleep -Seconds 30

      - name: Test irm installation method
        run: |
          Write-Host "Testing: irm ... | iex"
          irm https://raw.githubusercontent.com/harmonyvt/capycut/master/install.ps1 | iex

      - name: Verify irm installation
        run: |
          $localAppData = [Environment]::GetFolderPath("LocalApplicationData")
          $capycutPath = Join-Path $localAppData "Programs\capycut\capycut.exe"
          
          if (Test-Path $capycutPath) {
            & $capycutPath --version
          } else {
            Write-Error "capycut not found after irm install"
            exit 1
          }
          Write-Host "IRM installation method test passed!"

  # Summary job
  install-test-summary:
    needs: [test-install-linux, test-install-macos, test-install-windows, test-curl-install-linux, test-wget-install-linux, test-irm-install-windows]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check installation test results
        run: |
          echo "Post-Release Installation Test Summary"
          echo "======================================"
          echo ""
          echo "Direct script tests:"
          echo "  Linux (install.sh):      ${{ needs.test-install-linux.result }}"
          echo "  macOS (install.sh):      ${{ needs.test-install-macos.result }}"
          echo "  Windows (install.ps1):   ${{ needs.test-install-windows.result }}"
          echo ""
          echo "Remote installation tests:"
          echo "  Linux (curl):            ${{ needs.test-curl-install-linux.result }}"
          echo "  Linux (wget):            ${{ needs.test-wget-install-linux.result }}"
          echo "  Windows (irm):           ${{ needs.test-irm-install-windows.result }}"
          echo ""
          
          # Check for failures
          FAILED=0
          
          if [ "${{ needs.test-install-linux.result }}" = "failure" ]; then
            echo "FAILED: Linux install.sh test"
            FAILED=1
          fi
          
          if [ "${{ needs.test-install-macos.result }}" = "failure" ]; then
            echo "FAILED: macOS install.sh test"
            FAILED=1
          fi
          
          if [ "${{ needs.test-install-windows.result }}" = "failure" ]; then
            echo "FAILED: Windows install.ps1 test"
            FAILED=1
          fi
          
          if [ "${{ needs.test-curl-install-linux.result }}" = "failure" ]; then
            echo "FAILED: Linux curl installation test"
            FAILED=1
          fi
          
          if [ "${{ needs.test-wget-install-linux.result }}" = "failure" ]; then
            echo "FAILED: Linux wget installation test"
            FAILED=1
          fi
          
          if [ "${{ needs.test-irm-install-windows.result }}" = "failure" ]; then
            echo "FAILED: Windows irm installation test"
            FAILED=1
          fi
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "Some installation tests failed!"
            exit 1
          fi
          
          echo "All installation tests passed!"
